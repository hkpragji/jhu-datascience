---
title: "Fine particulate matter pollution in the US"
subtitle: "a 10-year analysis"
author: "Hiten Pragji"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    number_sections: true
    latex_engine: xelatex
geometry: margin=0.75in
fontsize: 11pt
header-includes:
  - \usepackage{amsmath}
  - \usepackage{amssymb}
  - \usepackage{graphicx}
  - \usepackage[numbers]{natbib}
  - \usepackage{url}
  - \usepackage{caption}
  - \usepackage{notoccite}
  - \usepackage{enumitem}
  - \usepackage{caption}
  - \usepackage{xcolor}
  - \usepackage{titlesec}
  - \usepackage{parskip}
  - \usepackage{hyperref}
  - \usepackage{mathtools}
  - \usepackage{bm}
  - \usepackage{dsfont}
  - \usepackage{bigints}
  - \usepackage[nointlimits]{esint}
  - \usepackage{titlesec}
---

Fine particulate matter (PM2.5) is an ambient air pollutant for which there is strong evidence that it is harmful to human health. In the United States, the Environmental Protection Agency (EPA) is tasked with setting national ambient air quality standards for fine PM and for tracking the emissions of this pollutant into the atmosphere. Approximately every 3 years, the EPA releases its database on emissions of PM2.5. This database is known as the National Emissions Inventory (NEI).

For each year and for each type of PM source, the NEI records how many tons of PM2.5 were emitted from that source over the course of the entire year. The data that you will use for this assignment are for 1999, 2002, 2005, and 2008.

```{r setup, echo=TRUE, warning=FALSE, message=FALSE}
# Load required libraries
library(tidyverse)
library(tinytex)
```

```{r read-data, echo=FALSE}
# Read datasets using readr::read_rds
pm_emissions <- readr::read_rds("summarySCC_PM25.rds")
src_classifications <- readr::read_rds("Source_Classification_Code.rds")
```

```{r preview-emissions, echo=FALSE}
# Preview the dataset structure
tibble::glimpse(pm_emissions)
tibble::glimpse(src_classifications)
```

The `pm_emissions` dataset contains all the PM2.5 emissions data for 1999, 2002, 2005, and 2008. For each year, the table contains the number of tonnes of PM2.5 emitted from a specific type of source for the entire year. The dataset contains 6,497,651 rows and 6 variables which are:

1. `fips`: Unique 5-digit classifier identifying the US county;
2. `SCC`: Source classification codes uniquely identifying the PM2.5 source;
3. `Pollutant`: The name of the pollutant;
4. `Emissions`: Amount of PM2.5 emitted (in tonnes);
5. `type`: The type of emission source (point, non-point, on-road, non-road, biogenic, event);
6. `year`: The year in which the emissions were recorded.

The United States Environmental Protection Agency (EPA) uses source classification codes (SCCs) to classify different types of activities that generate emissions. The `src_classifications` dataset contains 11,717 rows and 15 variables. The SCC hierarchy is organised into four tiers of increasing detail. Therefore, we will select the following variables:

1. `SCC`: Source classification codes uniquely identifying the PM2.5 source;
2. `Data.Category`: The type of emission source (point, non-point, on-road, non-road, biogenic, event);
3. `Short.Name`: Short descriptive names of the emissions process;
4. `EI.Sector`: Emissions inventory sector;
5. `SCC.Level.One`: Broad category (e.g. external combustion sources);
6. `SCC.Level.Two`: Subcategory (e.g. electric generation);
7. `SCC.Level.Three`: More detail (e.g. Anthracite Coal");
8. `SCC.Level.Four`: Most specific (e.g. Pulverised Coal").

Let's select the columns we want from the SCC dataset:

```{r, echo=TRUE}
# Select appropriate columns by indexing
src_classifications <- src_classifications[,c(1:4, 7:10)]
```

Next, we want to join the two datasets in preparation for analysis of emissions by the type of source:

```{r create-dataset, echo=TRUE}
# Get all the observations from `pm_emissions` that have a matching SCC
all_emissions_data <- pm_emissions %>%
  dplyr::left_join(
    src_classifications,
    by = c("SCC"),
  ) %>%
  # Coerce all character types to factor
  dplyr::mutate(across(where(is.character), as.factor),
    year = as.factor(year)
  )
  
# Preview the dataset structure
tibble::glimpse(all_emissions_data)
```

\textbf{Question 1: Have total emissions from PM2.5 decreased in the United States from 1999 to 2008?}

```{r plot-total-emissions, results='asis'}
chart_data <- all_emissions_data %>%
  dplyr::filter(fips == "09001")

create_barplot <- function(df) {
  total_emissions <- ggplot2::ggplot(
    df,
    aes(year, Emissions)
  ) +
    ggplot2::geom_bar(
      stat = "identity",
      fill = "#CC79A7",
      width = 0.75
    ) +
    # ggplot2::scale_x_continuous(labels = scales::label_comma) +
    ggplot2::scale_y_continuous(
      expand = c(0, 0),
      limits = c(0, 6000)
    ) +
    ggplot2::theme_classic() +
    ggplot2::labs(
      x = "Year",
      y = "Total PM2.5 emitted (in tonnes)",
      title = "Total PM2.5 emissions from all sources between 1999 and 2008"
    ) +
    ggplot2::theme(
      axis.ticks.length = grid::unit(0.2, "cm"),
      axis.title = element_text(face = "bold"),
      plot.title = element_text(hjust = 0.5, face = "bold"),
      plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm")
    ) +
    ggplot2::geom_text(
      aes(
        label = format(after_stat(y), nsmall = 2, digits = 3),
        group = year
      ),
      stat = "summary",
      fun = sum,
      vjust = -0.25
    )

  print(total_emissions)
}

create_barplot(chart_data)
```

\textbf{Have total emissions from PM2.5 decreased in the Baltimore City, Maryland (fips == "24510") from 1999 to 2008?}

```{r plot-maryland-emissions}
maryland_emissions <- all_emissions_data %>%
  dplyr::filter(fips == "24510")

create_barplot(maryland_emissions)
```

\textbf{Of the four types of sources indicated by the type (point, nonpoint, onroad, nonroad) variable, which of these four sources have seen decreases in emissions from 1999–2008 for Baltimore City? Which have seen increases in emissions from 1999–2008?}

```{r plot-emissions-by-type}
# Method 1: Plot faceted grid where each grid represents an emission type
create_facet_plot <- function(df) {
  maryland_emissions_by_type <- ggplot2::ggplot(
    df,
    aes(year, Emissions, fill = type)
  ) +
    ggplot2::geom_bar(
      stat = "identity",
      width = 0.75
    ) +
    # ggplot2::scale_x_continuous(labels = scales::label_comma) +
    ggplot2::scale_y_continuous(
      expand = c(0, 0),
      limits = c(0, 6000)
    ) +
    ggplot2::facet_wrap(
      .~type,
      ncol = 2,
      scales = "free",
      strip.position = "top"
    ) +
    ggplot2::theme_classic() +
    ggplot2::labs(
      x = "Year",
      y = "Total PM2.5 emitted (in tonnes)",
      title = "Total PM2.5 emissions from all sources between 1999 and 2008"
    ) +
    ggplot2::theme(
      axis.ticks.length = grid::unit(0.2, "cm"),
      axis.title = element_text(face = "bold"),
      plot.title = element_text(hjust = 0.5, face = "bold"),
      plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm"),
      strip.text = element_blank(),
      strip.background = element_blank(),
      panel.spacing = unit(1, "lines")
    ) +
    ggplot2::geom_text(
      aes(
        label = format(after_stat(y), nsmall = 2, digits = 3),
        group = year
      ),
      stat = "summary",
      fun = sum,
      vjust = -0.25
    )

  print(maryland_emissions_by_type)
}

create_facet_plot(maryland_emissions)

# Method 2: Plot a side-by-side bar chart
create_barplot_bytype <- function(df) {
  maryland_emissions_by_type <- ggplot2::ggplot(
    df,
    aes(year, Emissions, fill = type)
  ) +
    ggplot2::geom_bar(
      stat = "identity",
      width = 0.75,
      position = "dodge"
    ) +
    # ggplot2::scale_x_continuous(labels = scales::label_comma) +
    ggplot2::scale_y_continuous(
      expand = c(0, 0),
      limits = c(0, 6000)
    ) +
    ggplot2::theme_classic() +
    ggplot2::labs(
      x = "Year",
      y = "Total PM2.5 emitted (in tonnes)",
      title = "Total PM2.5 emissions from all sources between 1999 and 2008",
      fill = "Emission type"
    ) +
    ggplot2::theme(
      axis.ticks.length = grid::unit(0.2, "cm"),
      axis.title = element_text(face = "bold"),
      plot.title = element_text(hjust = 0.5, face = "bold"),
      plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm")
    ) +
    ggplot2::geom_text(
      aes(
        label = format(after_stat(y), nsmall = 2, digits = 3),
        group = year
      ),
      stat = "summary",
      fun = sum
    )

  print(maryland_emissions_by_type)
}

create_barplot_bytype(maryland_emissions)
```











