---
title: "Power, Bootstrapping, and Permutation Tests"
subtitle: ""
author: "Hiten Pragji"
date: ""
output: 
  pdf_document:
    latex_engine: xelatex
geometry: margin=0.75in
fontsize: 11pt
header-includes:
  - \usepackage{amsmath}
  - \usepackage{amssymb}
  - \usepackage{graphicx}
  - \usepackage[numbers]{natbib}
  - \usepackage{url}
  - \usepackage{caption}
  - \usepackage{notoccite}
  - \usepackage{enumitem}
  - \usepackage{caption}
  - \usepackage{xcolor}
  - \usepackage{titlesec}
  - \usepackage{parskip}
  - \usepackage{hyperref}
  - \usepackage{mathtools}
  - \usepackage{bm}
  - \usepackage{dsfont}
  - \usepackage{bigints}
  - \usepackage[nointlimits]{esint}
  - \usepackage{titlesec}
  - \usepackage{tabu}
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tinytex)
library(kableExtra)
knitr::opts_knit$set(echo = TRUE)
```

\textbf{Q1. A pharmaceutical company is interested in testing a potential blood pressure lowering medication. Their first examination considers only subjects that received the medication at baseline then two weeks later. The data is shown in Table 1 (SBP in mmHg). Consider testing the hypothesis that there was a mean reduction in blood pressure? Give the P-value for the associated two sided T test. (Hint, consider that the observations are paired.)}

```{r paired-t-test, echo=FALSE, results='asis'}
subject <- c(1, 2, 3, 4, 5)
baseline <- c(140, 138, 150, 148, 135)
followup <- c(132, 135, 151, 146, 130)

sbp <- data.frame(subject, baseline, followup)

kableExtra::kbl(
  sbp,
  format = "latex",
  align = "ccc",
  escape = TRUE,
  booktabs = TRUE,
  caption = "Systolic blood pressure readings (mmHg)"
) %>%
  kableExtra::kable_styling(
    position = "center",
    latex_options = "hold_position"
  )
```

\textbf{\underline{Solution}}

Given that the observations are paired and we are interested in the mean differences being zero or non-zero, we need to use a two-tailed paired $t$ test. Recall that a paired $t$ test is used to compare before-and-after observations on the same subjects, or to compare two different methods of measurement or two different treatments where the measurements/treatments are applied to the same subjects.

Let $H_{0}$ be the null hypothesis that there is no mean change in SBP, that is, $\mu_{d_{i}} = 0$, where $d_{i}$ is the difference between observations on the same subject $i$. Also let $H_{1}$ be the alternative hypothesis that there is a mean change in SBP, that is, $\mu_{d_{i}} \neq 0$. Taking $H_{0}: \mu_{d_{i}} = 0$ gives the observed test statistic $t_{obs}$:

\begin{align}
  t = \frac{\bar{d_{i}} - 0}{S/\sqrt{n}}
\end{align}

where $n$ is the number of subjects and $S$ is the sample standard deviation. Let's test our hypotheses using the `t.test()` function:

```{r solution1}
dep.t.test <- t.test(baseline, followup, paired = TRUE)
print(dep.t.test)
```

Therefore, $t_{obs} \approx 2.262$ and the $p$-value for the associated two-sided $t$-test is given by $p = \mathbb{P}(|T| \geq |t_{obs}|) \approx 0.087$.

\rule{\textwidth}{0.5pt}

\textbf{Q2. A sample of 9 men yielded a sample average brain volume of 1,100 cc and a standard deviation of 30 cc. What is the complete set of values of $\mu_{0}$ that a test of $H_{0}: \mu = \mu_{0}$ would fail to reject the null hypothesis in a two-sided 5$\%$ Student's $t$-test?}

\textbf{\underline{Solution}}

For this question, we need to determine the two-sided 95$\%$ confidence interval (CI) for the population mean $\mu$ using the sample average $\bar{x}$ and the sample standard deviation $s$. Hence we need a range of values around $\mu$ that satisfies the following equation

\begin{align}
  \mathbb{P}\left(\bar{x} - \frac{t_{n-1}^{0.025}s}{\sqrt{n}} < \mu < \bar{x} + \frac{t_{n-1}^{0.025}s}{\sqrt{n}}\right) = 0.95
\end{align}

that is, the 95$\%$ CI is given by

\begin{align}
  \left(\bar{x} - \frac{t_{n-1}^{0.025}s}{\sqrt{n}}, \bar{x} + \frac{t_{n-1}^{0.025}s}{\sqrt{n}}\right)
\end{align}

where $t_{n-1}$ is the observed test statistic from the Students t-distribution with $n-1$ degrees of freedom. We can use the `qt()` function from the `stats` base package to find the $t$-score of the 95$^{\text{th}}$ quartile of the $t$ distribution with $n - 1$ degrees of freedom. Then, we substitute our values into Equation (3) to determine the 95$\%$ CI as follows:

```{r solution2}
n <- 9
avg_bv <- 1100
sd_bv <- 30
t_obs <- qt(0.975, df = (n - 1))
# Calculate the lower and upper confidence limits
lower_cl <- avg_bv - ((t_obs * sd_bv) / sqrt(9))
upper_cl <- avg_bv + ((t_obs * sd_bv) / sqrt(9))
print(paste0(round(lower_cl, 3), " - ", round(upper_cl, 3)))
```

Therefore, a two-sided 5$\%$ Student's $t$-test fails to reject the null hypothesis $H_{0}: \mu = \mu_{0}$ for all values of $\mu_{0}$ in the interval 1077 < $\mu_{0}$ < 1123.

\rule{\textwidth}{0.5pt}

\textbf{Q3. Researchers conducted a blind taste test of Coke versus Pepsi. Each of four people were asked which of two blinded drinks given in random order that they preferred. The data was such that 3 of the 4 people chose Coke. Assuming that this sample is representative, report a $P$-value for a test of the hypothesis that Coke is preferred to Pepsi using a one-sided exact test.}

\textbf{\underline{Solution}}

This problem can be modelled using a Binomial distribution where:

\begin{itemize}
  \item The random variable $X$ is the number of people in the sample who prefer Coke: $X \tilde \text{Bin}(n, p)$;
  \item The population parameter $p$ is defined as the proportion of people who prefer Coke to Pepsi;
  \item $n$ is the number of people participating in the taste test.
\end{itemize}

Let's write down the method before running the `binom.test()` function:

\begin{itemize}
  \item The null hypothesis is that there is no preference between Coke and Pepsi - $H_{0}: p = 0.5$;
  \item The alternative hypothesis is that there is a preference between Coke and Pepsi - $H_{1}: p > 0.5$.
\end{itemize}

```{r solution3}
binom.test(x = 3, n = 4, p = 0.5, alternative = "greater")
```

Since $p = 0.3125 \geq 0.05$, we fail to reject the null hypothesis; there is insufficient evidence to conclude that people prefer Coke to Pepsi.

\rule{\textwidth}{0.5pt}

\textbf{Q4. Infection rates at a hospital above 1 infection per 100 person days at risk are believed to be too high and are used as a benchmark. A hospital that had previously been above the benchmark recently had 10 infections over the last 1,787 person days at risk. About what is the one-sided $P$-value for the relevant test of whether the hospital is \emph{below} the standard?}

\textbf{\underline{Solution}}

This problem can be modelled using a Poisson distribution, where the population parameter $\lambda$ is defined as the mean number of infections over the specified period. That is, $\lambda = r \times \text{person days at risk} = 0.01 \times 1787 = 17.87$, where $r$ is the infection rate per person-day. We have the following hypotheses:

\begin{itemize}
  \item The null hypothesis is that the hospital is at the standard of 1 infection per 100 person days at risk - $H_{0}: r = 0.01$.
  \item The alternative hypothesis is that the hospital is below the standard of 1 infection per 100 person days at risk - $H_{1}: r < 0.01$.
\end{itemize}

Using the `poisson.test()` function, we can find the one-sided $p$-value:

```{r solution4}
poisson.test(x = 10, T = 1787, r = 0.01, alternative = "less")
```

Therefore, $p = 0.03237 \leq 0.05$ which means there is sufficient evidence at the 5$%$ significance level to reject $H_{0}$ and conclude that the hospital is below the standard.

\rule{\textwidth}{0.5pt}

\textbf{Q5. Suppose that 18 obese subjects were randomized, 9 each, to a new diet pill and a placebo. Subjects’ body mass indices (BMIs) were measured at a baseline and again after having received the treatment or placebo for four weeks. The average difference from follow-up to the baseline (follow-up - baseline) was −3 kg m$^{-2}$ for the treated group and 1 kg m$^{-2}$ for the placebo group. The corresponding standard deviations of the differences was 1.5 kg m$^{-2}$ for the treatment group and 1.8 kg m$^{-2}$ for the placebo group. Does the change in BMI appear to differ between the treated and placebo groups? Assuming normality of the underlying data and a common population variance, give a $p$-value for a two sided $t$-test.}

\textbf{\underline{Solution}}

For this problem, the assumptions are that the two samples come from normal distributions, are independent, and that the populations from which they are taken have the same variance. Hence we need to conduct a hypothesis test for the difference between means from two independent normal distributions with equal but unknown variances. The observed test statistic is given by

\begin{align}
  \frac{(\bar{x} - \bar{y}) - (\mu_{x} - \mu_{y})}{s_{p}\sqrt{\frac{1}{n_{x}} + \frac{1}{n_{y}}}} \approx t_{n_{x} + n_{y} - 2}^{\alpha/2}
\end{align}

where $n_{x}$ and $n_{y}$ are the sample sizes of the diet and placebo groups, respectively, $\mu_{x}$ and $\mu_{y}$ are the sample average differences of the diet and placebo groups, respectively, and $s_{p}$ is the pooled estimate of the population standard deviation which is given by

\begin{align}
  s_{p} = \frac{(n_{x} - 1)s_{x}^{2} + (n_{y} - 1)s_{y}^{2}}{n_{x} + n_{y} - 2}
\end{align}

where $s_{x}$ and $s_{y}$ are the sample standard deviations of the diet and placebo groups, respectively. Let's define our hypotheses:

\begin{itemize}
  \item The null hypothesis is that there is no mean difference in BMI between the treatment and placebo groups - $H_{0}: \mu_{x} = \mu_{y}$;
  \item The alternative hypothesis is that there is a mean difference in BMI between the treatment and placebo groups - $H_{0}: \mu_{x} \neq \mu_{y}$;
\end{itemize}

We can test our null hypothesis by finding the $p$-value associated with the following test statistic, which for $H_{0}$ is given by simplifying Equation (4) to

\begin{align}
  \frac{(\bar{x} - \bar{y})}{s_{p}\sqrt{\frac{1}{n_{x}} + \frac{1}{n_{y}}}} \approx t_{n_{x} + n_{y} - 2}^{\alpha/2}
\end{align}

We can find the $p$-value by using the `pt()` function after evaluating 

```{r solution5}
n_x <- 9
n_y <- 9
avg_x <- -3
avg_y <- 1
sd_x <- 1.5
sd_y <- 1.8
# Define number of degrees of freedom
df = n_x + n_y - 2
# Calculate pooled estimate of population variance
pooled_var <- (((n_x - 1) * sd_x^2) + ((n_y - 1) * sd_y^2)) / (n_x + n_y - 2)
# Take square root to find pooled estimate of population standard deviation
pooled_sd <- sqrt(pooled_var)
# Calculate denominator of Equation (5): standard error
se <- pooled_sd * sqrt(1/n_x + 1/n_y)
# Substitute values into Equation (5) to find test statistic
t_obs <- (avg_y - avg_x) / se
# Calculate two-sided p-value
p_value <- 2 * (1 - pt(q = t_obs, df = df))
p_value
```

We see that $p \approx 0.0001025174 \leq 0.05$ which means there is sufficient evidence at the 5$\%$ level to reject $H_{0}$ and conclude that the change in BMI does appear to differ between the treatment and placebo groups.

\rule{\textwidth}{0.5pt}

\textbf{Q6. Brain volumes for 9 men yielded a 90$\%$ confidence interval of 1,077 cc to 1,123 cc. Would you reject in a two-sided 5$\%$ hypothesis test of $H_{0}: \mu = 1,078$?}

\textbf{\underline{Solution}}

Since the hypothesised $\mu$ value lies within the 90$\%$ CI [1077, 1123], the corresponding two-sided $p$-value is greater than 0.10. Therefore, at the 5$\%$ significance level, we fail to reject the null hypothesis that the mean brain volume is 1078.

\rule{\textwidth}{0.5pt}

\textbf{Q7. Researchers would like to conduct a study of 100 healthy adults to detect a four year mean brain volume loss of 0.01 mm$^{3}$. Assume that the standard deviation of four year volume loss in this population is 0.04 mm$^{3}$. About what would be the power of the study for a 5$\%$ one-sided test versus a null hypothesis of no volume loss?}

\textbf{\underline{Solution}}

**Definition 7.1**: (Type I error) A Type I error occurs when the null hypothesis is rejected despite being true. The probability of a Type I error is the same as the actual significance level of the hypothesis test.

**Definition 7.2**: (Type II error) A Type II error occurs when the null hypothesis is accepted despite being false.

**Definition 7.3**: (Power) The \textbf{power} of a test is the probability of rejecting the null hypothesis when it is not true. It is defined as $1 - \mathbb{P}(\text{Type II error})$ which is the probability of being in the critical region when $H_{0}$ is false.

The greater the power of a test, the greater the probability of rejecting $H_{0}$ when $H_{0}$ is false. It follows that the higher the power, the better the test. If the power is greater than 0.5, the probability of coming to the correct conclusion (rejecting $H_{0}$ when $H_{0}$ is false) is greater than the probability of coming to the wrong conclusion (accepting $H_{0}$ when $H_{0}$ is false).

Let's define the hypotheses:

\begin{itemize}
  \item The null hypothesis is that there is no mean brain volume loss - $H_{0}: \mu_{d_{i}} = 0$;
  \item The alternative hypothesis is that there is a mean brain volume loss - $H_{1}: \mu_{d_{i}} \neq 0$.
\end{itemize}

We can use the `power.t.test()` function to compute the power of the one-sided $t$-test:

```{r solution7}
n <- 100
avg_bv_loss <- 0.01
sd_bv_loss <- 0.04
a <- 0.05
power.t.test(
  n = n,
  delta = avg_bv_loss,
  sd = sd_bv_loss,
  sig.level = a,
  type = "one.sample",
  alternative = "one.sided"
  )
```

Hence, for a one-sided test at the 5$\%$ significance level, a study with 100 healthy adults has approximately 80$\%$ power to detect a mean four-year brain volume loss of 0.01 mm$^{3}$, assuming a standard deviation of 0.04 mm$^{3}$.

\rule{\textwidth}{0.5pt}

\textbf{Q8. Researchers would like to conduct a study of $n$ healthy adults to detect a four-year mean brain volume loss of 0.01 mm$^{3}$. Assume that the standard deviation of four year volume loss in this population is 0.04 mm$^{3}$. About what would be the value of $n$ needed for 90$\%$ power of Type I error rate of 5$\%$ one-sided test versus a null hypothesis of no volume loss?}

\textbf{\underline{Solution}}

We can also use the `power.t.test()` function to determine parameters to obtain a target power of 90$\%$:

```{r solution8}
avg_bv_loss <- 0.01
sd_bv_loss <- 0.04
pow <- 0.90
a <- 0.05
power.t.test(power = pow,
             delta = avg_bv_loss,
             sd = sd_bv_loss,
             sig.level = a,
             type = "one.sample",
             alternative = "one.sided"
             )
```

Therefore the requirement on $n$ is $n = 140$.

\rule{\textwidth}{0.5pt}

\textbf{Q9. As you increase the Type I error rate, $\alpha$, what happens to power?}

\textbf{\underline{Solution}}

Since the probability of a Type I error is the same as the actual significance level of the test, if we increase the Type I error rate then the power increases too.

\rule{\textwidth}{0.5pt}
